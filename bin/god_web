#!/usr/bin/env ruby

require File.dirname(__FILE__) + '/../lib/environment'

OptionParser.new { |op|
  op.on('-e env')    { |val| set :environment, val.to_sym }
  op.on('-s server') { |val| set :server, val }
  op.on('-p port')   { |val| set :port, val.to_i }
}.parse!(ARGV.dup)

set :run, true

before do
  unless (GODWEB_CONFIG['username'].nil? && GODWEB_CONFIG['password'].nil?) || self.request.path_info == '/heartbeat'
    authenticate_or_request_with_http_basic "GodWeb" do
      |user, pass| user == GODWEB_CONFIG['username'] && pass == GODWEB_CONFIG['password']
    end
  end
  GODWEB.ping
end

get '/' do
  @statuses = GODWEB.status
  @watches = []
  @statuses.each do |watch, status|
    @watches << watch.to_s
  end
  @watches.sort!
  @groups = GODWEB.groups
  show(:status)
end

get '/w/:watch' do
  @watch = params["watch"]
  @status = GODWEB.status[@watch][:state]
  @commands = GodWeb.possible_statuses(@status)
  show(:watch, "#{@watch} [#{@status}]")
end

get '/g/:group' do
  @watch = @group = params["group"]
  @status = nil
  @commands = GodWeb.possible_statuses(@status)
  show(:watch, "#{@group} [group]")
end

get '/w/:watch/:command' do
  @watch = params["watch"]
  @command = params["command"]
  @success = GODWEB.send(@command, @watch)
  @success = false if @success == []
  show(:command, "#{@command}ing #{@watch}")
end

get '/heartbeat' do
  @statuses = GODWEB.status
  'OK'
end

private

  def show(template, title = 'GodWeb')
    @title = title
    erb(template)
  end
